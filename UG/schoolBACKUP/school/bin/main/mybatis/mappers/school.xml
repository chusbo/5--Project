<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.sc.dao.SchoolDAO">
	<resultMap id="Result" type="com.project.sc.vo.SchoolVO">
		<result property="attendance_no" column="attendance_no"/>
		<result property="st_no" column="st_no"/>
		<result property="attendance_date" column="attendance_date"/>
		<result property="attendance_status" column="attendance_status"/>
		<result property="board_no" column="board_no"/>
		<result property="title" column="title"/>
		<result property="article" column="article"/>
		<result property="cre_date" column="cre_date"/>
		<result property="grade_no" column="grade_no"/>
		<result property="sub_no" column="sub_no"/>
		<result property="senester" column="senester"/>
		<result property="score" column="score"/>
		<result property="st_name" column="st_name"/>
		<result property="st_birth" column="st_birth"/>
		<result property="st_gender" column="st_gender"/>
		<result property="st_addr" column="st_addr"/>
		<result property="st_phone" column="st_phone"/>
		<result property="st_parent_phone" column="st_parent_phone"/>
		<result property="st_grade" column="st_grade"/>
		<result property="tc_no" column="tc_no"/>
		<result property="st_statuts" column="st_statuts"/>
		<result property="sub_name" column="sub_name"/>
		<result property="tc_name" column="tc_name"/>
		<result property="tc_birth" column="tc_birth"/>
		<result property="tc_gender" column="tc_gender"/>
		<result property="tc_addr" column="tc_addr"/>
		<result property="tc_phone" column="tc_phone"/>
		<result property="tc_hired" column="tc_hired"/>
		<result property="user_id" column="user_id"/>
		<result property="user_pwd" column="user_pwd"/>
		<result property="user_grant" column="user_grant"/>
		<result property="tc_status" column="tc_status"/>
	</resultMap>

	<select id="selectAllSubs" resultMap="Result">
		select s.sub_no, s.sub_name, t.tc_name 
		from subject s
		left join teacher t on s.sub_no = t.sub_no
	</select>

	<select id="selectSubsByNos" parameterType="list" resultMap="Result">
		select s.sub_no, s.sub_name, t.tc_name 
		from subject s
		left join teacher t on s.sub_no = t.sub_no
		where s.sub_no in 
		<foreach item="item" index="index" collection="list" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>

	<select id="selectAllSubNames" resultMap="Result">
		select sub_no, sub_name 
		from subject
	</select>

	<insert id="insertSub" parameterType="com.project.sc.vo.SchoolVO">
		insert into subject (sub_no, sub_name) values (#{sub_no}, #{sub_name})
	</insert>

	<delete id="deleteSub" parameterType="String">
		delete from subject where sub_no = #{sub_no}
	</delete>

	<select id="selectUserById" parameterType="String" resultMap="Result">
		select * from teacher where user_id = #{user_id}
	</select>

	<update id="updateUser" parameterType="com.project.sc.vo.SchoolVO">
		update teacher set tc_phone = #{tc_phone}, tc_addr = #{tc_addr} where user_id = #{user_id}
	</update>

	<select id="selectGradeAverages" resultType="map">
		select s.st_grade as grade, sub.sub_name as subject, avg(g.score) as avg_score
		from grade g
		join student s on g.st_no = s.st_no
		join subject sub on g.sub_no = sub.sub_no
		group by s.st_grade, sub.sub_name
		order by s.st_grade, sub.sub_name
	</select>

	<select id="getAvgScoresBySem" resultType="map">
		select s.st_grade as grade, sub.sub_name as subject, avg(g.score) as avg_score
		from grade g
		join student s on g.st_no = s.st_no
		join subject sub on g.sub_no = sub.sub_no
		where g.senester = #{semester}
		group by s.st_grade, sub.sub_name
		order by s.st_grade, sub.sub_name
	</select>
	
	<select id="getRanks" resultType="map">
	    select 
	        s.st_grade as grade,
	        s.st_name as name,
	        avg(g.score) as avg_score,
	        rank() over (partition by s.st_grade order by avg(g.score) desc) as `rank`
	    from 
	        grade g
	    join 
	        student s on g.st_no = s.st_no
	    group by 
	        s.st_grade, s.st_name
	    order by 
	        s.st_grade, `rank`
	</select>
</mapper>
